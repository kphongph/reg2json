<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../mongo-document.html">

<dom-module id="course-outcome">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      
      .paper-font-body1 {
        @apply(--paper-font-body1);
      }
      
    </style>
    
    <iron-ajax id="updateAjax"
      method="PUT"
      handle-as="json"
      content-type="application/json">
    </iron-ajax>
    
    <mongo-document url="/mongo/tqf/curriculum_course_rel" 
      doc-id="{{relationId}}" 
      doc="{{relation}}">
    </mongo-document>
    
    <mongo-document url="/mongo/tqf/curriculum" 
      doc-id="{{relation.curriculum_id}}" 
      doc="{{curriculum}}">
    </mongo-document>
    
    
    <div class="vertical layout">
      <div>
        <paper-radio-group selected="{{relation.learning_outcome.name}}">
          <template is="dom-repeat" items="{{curriculum.learning_outcome_list}}">
            <paper-radio-button name="{{item.name}}">{{item.name}}</paper-radio-button>
          </template>
        </paper-radio-group>
      </div>
      <div class="horizontal layout">
        <template is="dom-repeat" items="{{relation.learning_outcome.content}}">
          <div class="flex self-center">{{item.label}}</div>
        </template>
      </div>
      <div class="horizontal layout">
        <template is="dom-repeat" items="{{relation.learning_outcome.content}}">
          <div class="flex self-center">
            <tristate-checkbox state="{{item.value}}"></tristate-checkbox>
          </div>
        </template>
      </div>
    </div>
    
  </template>
  <script>
    Polymer({
      is: 'course-outcome',
      properties: {
        relationId: {
          type:String,
          notify:true
        },
        relation:Object,
        curriculum: {
          type:Object,
          notify:true
        }
      },
      observers: [
        '_mapping(relation, curriculum)',
        '_change(relation.learning_outcome.name, curriculum)',
        'outcomeChanged(relation.learning_outcome.content.*)'
      ],
      _change:function(name,curriculum) {
        //console.log(this.relation);
        this._mapping(this.relation,curriculum);
      },
      outcomeChanged:function(changeRecord) {
        if(changeRecord.path.endsWith('value')) {
          var tmp = JSON.parse(JSON.stringify(this.relation));
          delete tmp['_id'];
          this.$.updateAjax.url="/mongo/tqf/curriculum_course_rel/"+this.relation._id;
          this.$.updateAjax.body = tmp;
          //console.log(tmp);
          this.$.updateAjax.generateRequest();
        }
      },
      _mapping:function(relation,curriculum) {
        var category = null;
        if(relation.learning_outcome == null) {
          this.set('relation.learning_outcome',{'name':'','content':[]});
        }
        
        for(var i=0;i<curriculum.learning_outcome_list.length;i++) {
          if(curriculum.learning_outcome_list[i].name == relation.learning_outcome.name) {
            category = curriculum.learning_outcome_list[i];
            break;
          }
        }
        var sorted_content = [];
        if(category!=null) {
          for(var i=0;i<category.content.length;i++) {
            var item = category.content[i];
            item.value = 0;
            for(var j=0;j<relation.learning_outcome.content.length;j++) {
              var tmp = relation.learning_outcome.content[j];
              if(item.label == tmp.label && item.type == tmp.type) {
                if(tmp.value!=null) {
                  item.value = tmp.value;
                } 
                break;
              }
            }
            sorted_content.push(item);
            this.push('relation.learning_outcome.content',item);
          }
        }
        console.log(sorted_content);
        if(sorted_content.length) {
          this.splice('relation.learning_outcome.content',
            sorted_content.length,sorted_content.length);
        }
      }
    });
  </script>
</dom-module>